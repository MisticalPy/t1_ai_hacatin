{% extends 'base.html' %}

{% block optional_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/theme/dracula.min.css" />
    <style>
        .editor-wrapper {
            width: 1006px;
            height: 289px;
            margin: 12px auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
            border-radius: 4px;
            overflow: hidden;
            background: white;
            cursor: text;
        }
        .CodeMirror { height: 100% !important; }
        .CodeMirror {
            background-color: #F7FAFC !important;
            border: 1px solid #DFE7F0 !important;
            height: 100% !important;
        }
        .CodeMirror-gutters {
            background-color: #4ec4ff !important;
            border-right: 1px solid #DFE7F0 !important;
        }
        .CodeMirror-linenumber {
            color: #ffffff !important;
        }
    </style>
{% endblock %}


{% block content %}

<main class="second_main">
<div class="second_base">
    <div class="filters-header">
            <span class="filters-header__pill">{{task.difficulty}}</span>
    </div>
    <div class="second_textarea">
        <p>
            <span>{{task.title}}</span><br>{{task.description}}
        </p>
        <p>
            <span>–í—Ö–æ–¥–Ω—ã–µ –∏ –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</span>
            {% for tc in testcases %}
            <br>–í—Ö–æ–¥: {{ tc.input_data }} ‚Üí –í—ã—Ö–æ–¥: {{ tc.output_data }}
            {% endfor %}
        </p>
    </div>

    <div class="ide_sec">
        <div class="editor-wrapper" id="editorWrapper">
            <textarea id="editorTextarea" placeholder="# –ù–∞–ø–∏—à–∏ Python –∫–æ–¥ –∑–¥–µ—Å—å"></textarea>
        </div>
    </div>

    <div class="ide_buttons">
        <div style="width: 230px; height: 100%;"></div>
        <div style="height: 62px; width: 230px;">
            <button class="button_enter_ide" id="button_enter_ide">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>
</div>
</main>

{# === SCRIPT CODEMIRROR === #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/addon/display/placeholder.min.js"></script>

<script>
    const STORAGE_KEY = 'python_editor_autosave_v1';
    const DEFAULT_CODE = "# –ü—Ä–∏–º–µ—Ä Python\nprint('Hello, world!')\n";
    const textarea = document.getElementById('editorTextarea');
    const editor = CodeMirror.fromTextArea(textarea, {
        mode: 'python',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        matchBrackets: true,
        autoCloseBrackets: true,
        theme: 'default',
        lineWrapping: true,
        viewportMargin: Infinity,
        placeholder: "# –í–∞—à Python –∫–æ–¥..."
    });

    const saved = localStorage.getItem(STORAGE_KEY);
    editor.setValue(saved !== null ? saved : DEFAULT_CODE);

    let saveTimeout = null;
    editor.on('change', () => {
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            try { localStorage.setItem(STORAGE_KEY, editor.getValue()); }
            catch (e) {}
        }, 500);
    });

    editor.setOption("extraKeys", {
        "Tab": function(cm) {
            cm.replaceSelection(" ".repeat(4), "end");
        }
    });

    window.PythonEditor = {
        getValue: () => editor.getValue()
    };
</script>

{# === –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ === #}
<script>
    const getCookie = (name) =>
        document.cookie.split('; ').find((row) => row.startsWith(name + '='))?.split('=')[1] || null;

    const runBtn = document.getElementById('button_enter_ide');

    if (runBtn) {
        runBtn.addEventListener('click', async () => {
            const code = window.PythonEditor.getValue();

            try {
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ code: code })
                });

                await response.json(); // –º–æ–∂–µ—à—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –µ—Å–ª–∏ —Ö–æ—á–µ—à—å

                // üî• –†–ï–î–ò–†–ï–ö–¢ –ë–ï–ó /tasks
                const current = window.location.href;
                const newUrl = current.replace(/\/tasks\/?$/, '');
                window.location.href = newUrl;

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:', err);
            }
        });
    }
</script>

{% endblock %}
