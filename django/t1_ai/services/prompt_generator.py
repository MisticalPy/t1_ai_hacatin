from django.db.models.query import QuerySet


class PromptGenerator:
    """–ö–ª–∞—Å—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –º–æ–¥–µ–ª–∏,
    –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –ª—é–±–æ–π –ò–ò –º–æ–¥–µ–ª–∏.

    –°–¥–µ–ª–∞–ª –∫–∞–∫ –∫—Ä—É—Ç–æ–π –≤—ã–Ω–µ—Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏–∑ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
    –∂–∞–ª—å —á—Ç–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ç–∞–∫ –º–∞–ª–æ."""

    QUESTION_BASE_SYSTEM_PROMPT = """
        –¢—ã ‚Äî –ò–ò-—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏.
        
        üéØ –¶–µ–ª—å: –ø–æ–Ω—è—Ç—å —É—Ä–æ–≤–µ–Ω—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –ø–æ —Ç–µ—Ö. —Å—Ç—ç–∫—É –≤–∞–∫–∞–Ω—Å–∏–∏
        –∏ –∑–∞–¥–∞—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å –µ–≥–æ.
        
        ---
        
        üìÑ –î–ê–ù–ù–´–ï –í–ê–ö–ê–ù–°–ò–ò (–Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–∏—á–µ–≥–æ —Å–≤–µ—Ä—Ö —ç—Ç–æ–≥–æ):
        - –ó–∞–≥–æ–ª–æ–≤–æ–∫: {title}
        - –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {direction}
        - –û–∂–∏–¥–∞–µ–º—ã–π –æ–ø—ã—Ç: {experience}
        - —É–¥–∞–ª–µ–Ω–Ω—ã–π: {work_format}
        - –í–∏–ª–∫–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã: –æ—Ç {salary_from} –¥–æ {salary_to}
        - –û–ø–∏—Å–∞–Ω–∏–µ: {description}
        - –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: {requirements}
        - –•–∞—Ä–¥-—Å–∫–∏–ª–ª—ã: {hard_skills}
        
        ---
        
        üìÑ –†–µ–∑—é–º–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—Å–∞–ª —ç—Ç–æ)
        {resume}
        
        ---
        
        üìå –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´:
        
        1. –í—Å–µ–≥–¥–∞ –∑–∞–¥–∞–≤–∞–π –¢–û–õ–¨–ö–û –û–î–ò–ù –≤–æ–ø—Ä–æ—Å –≤ –∫–æ–Ω—Ü–µ —Å–≤–æ–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
        2. –ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è **—Ç—ã –∑–∞–¥–∞—ë—à—å —Ç–æ–ª—å–∫–æ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –∏ –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã**:
        - –ø—Ä–æ –æ–ø—ã—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞,
        - –ø—Ä–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ hard_skills,
        - –ø—Ä–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –ø–æ–¥—Ö–æ–¥—ã, –ø—Ä–∏–Ω—Ü–∏–ø—ã.
        –ù–µ –ø—Ä–æ—Å–∏ –ø–∏—Å–∞—Ç—å –∫–æ–¥, –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –æ—à–∏–±–∫–∏ –∏–ª–∏ —Ä–µ—à–∞—Ç—å –∑–∞–¥–∞—á–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å—ã ‚Äú–Ω–∞ —Å–ª–æ–≤–∞—Ö‚Äù.
        3. –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –∑–∞–¥–∞—ë—Ç —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ –æ—Ç–≤–µ—Ç—å –µ–º—É,
        –∞ –∑–∞—Ç–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞–π –°–í–û–ô —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å.
        4. –û–±—â–∞–π—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã –∏ –¥–ª–∏–Ω–Ω—ã—Ö –ª–µ–∫—Ü–∏–π.
        5. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–µ–ø–æ–ª–Ω—ã–π –∏–ª–∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–π ‚Äî –ø–æ–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å, —É–≥–ª—É–±–∏—Ç—å—Å—è.
        6. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É—Å–ª–æ–∂–Ω—è–π –≤–æ–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ –≤–∏–¥–∏—à—å, —á—Ç–æ –∫–∞–Ω–¥–∏–¥–∞—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç.
        7. –¢—ã –º–æ–∂–µ—à—å –≤—Å–µ–≥–æ –∑–∞–¥–∞—Ç—å {count_questions} - –∏—Å–ø–æ–ª—å–∑—É–π –≤–æ–ø—Ä–æ—Å—ã —Å —É–º–æ–º, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ 
        –ø—Ä–æ —Ä–µ–∑—é–º–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ —Ö–∞—Ä–¥ —Å–∫–∏–∏–ª—ã
        
        üö´ –ó–ê–ü–†–ï–©–ï–ù–û:
        - –ø—Ä–æ—Å–∏—Ç—å –ø–∏—Å–∞—Ç—å –∫–æ–¥, –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –æ—à–∏–±–∫–∏, —Ä–µ—à–∞—Ç—å –∑–∞–¥–∞—á–∏;
        - –≤—ã–≤–æ–¥–∏—Ç—å JSON –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã;
        - –∑–∞–≤–µ—Ä—à–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –≤–æ–ø—Ä–æ—Å–∞
        - –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –≤–∞–∫–∞–Ω—Å–∏–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
        
        ---
        
        üîö –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –∏–ª–∏ —Å–æ–≤—Å–µ–º –Ω–µ –ø–æ —Ç–µ–º–µ ‚Äî
        —Å–∫–∞–∂–∏ –µ–º—É –æ–± —ç—Ç–æ–º –≤–µ–∂–ª–∏–≤–æ –∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å.
        
        –ù–∞—á–Ω–∏ —Å –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –æ–± –æ–ø—ã—Ç–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.
        """

    @classmethod
    def generate_question(cls, interview) -> dict:
        cur_vacancy = interview.vacancy

        # –°–æ—Å—Ç–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        messages = [
            {"role": "system",
             "content": cls.QUESTION_BASE_SYSTEM_PROMPT.format(
                 title=cur_vacancy.title,
                 direction=cur_vacancy.direction,
                 experience=cur_vacancy.experience,
                 work_format=cur_vacancy.is_remote,
                 salary_from=cur_vacancy.salary_from,
                 salary_to=cur_vacancy.salary_to,
                 description=cur_vacancy.description,
                 requirements=cur_vacancy.requirements,
                 hard_skills=cur_vacancy.hard_skills,
                 count_questions=cur_vacancy.total_questions,
                 ###
                 resume=interview.resume.about
             )}
        ]

        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        qa_list: QuerySet = interview.qas.all()

        for qa in qa_list:
            messages.append(
                {"role": "assistant",
                 "content": qa.question,}
            )

            messages.append(
                {"role": "user",
                 "content": qa.user_answer}
            )

        return {"messages": messages}

